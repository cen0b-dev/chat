<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>f0xnet // Secure</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#000000',
                        surface: '#0F0F0F',
                        surfaceHighlight: '#1C1C1E',
                        primary: '#D14E42', 
                        primaryDim: '#8A2C23',
                        statusGreen: '#34C759',
                        statusYellow: '#FFD60A',
                        statusGray: '#8E8E93',
                    },
                    fontFamily: {
                        sans: ['SF Pro Text', '-apple-system', 'BlinkMacSystemFont', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'SF Mono', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'enter-message': 'enterMessage 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards',
                        'slide-up-modal': 'slideUpModal 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'fade-out': 'fadeOut 1s ease-out forwards',
                    },
                    keyframes: {
                        enterMessage: {
                            '0%': { opacity: '0', transform: 'translateY(15px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        slideUpModal: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', filter: 'blur(0px)' },
                            '100%': { opacity: '0', filter: 'blur(4px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        html, body {
            background-color: #000000;
            color: #ffffff;
            position: fixed; 
            width: 100%;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; /* Handled by JS for gestures */
            font-feature-settings: "ss01", "ss02";
            overscroll-behavior: none;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.02));
            background-size: 100% 3px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.3;
        }

        .glass {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-modal {
            background: rgba(22, 22, 24, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .glass-input {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, textarea, select { font-size: 16px !important; } 

        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .top-spacing { padding-top: calc(60px + env(safe-area-inset-top)); }
        .bottom-spacing { padding-bottom: calc(75px + env(safe-area-inset-bottom)); }

        /* iMessage Swipe Reveal */
        .message-row {
            display: flex;
            width: 100%;
            transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1);
            position: relative;
        }
        
        .msg-bubble-container {
            width: 100%;
            flex-shrink: 0;
        }

        .msg-timestamp-reveal {
            width: 65px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .swiping .msg-timestamp-reveal { opacity: 1; }

        .msg-bubble {
            position: relative;
            max-width: 78%;
            padding: 10px 14px;
            font-size: 16px;
            line-height: 1.45;
            letter-spacing: -0.015em;
        }
        
        .msg-user { background-color: #D14E42; color: white; border-radius: 20px 20px 4px 20px; margin-left: auto; }
        .msg-ai { background-color: #2C2C2E; color: #F2F2F7; border-radius: 20px 20px 20px 4px; margin-right: auto; }

        .msg-system {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 10px;
            color: #555;
            text-align: center;
            width: 100%;
            padding: 12px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .msg-status-line {
            font-size: 10px;
            color: #8E8E93;
            margin-top: 2px;
            text-align: right;
            padding-right: 4px;
            font-weight: 500;
            display: none; /* Only show on last user message */
        }
        .last-user-msg .msg-status-line { display: block; }

        /* Sapper UI Refinement */
        .sapper-mode-active body { background-color: #080202; }
        .sapper-mode-active #main-header { border-bottom: 1px solid rgba(209, 78, 66, 0.3); }

        .sapper-pull-hint {
            position: absolute;
            bottom: 100px;
            left: 0; right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.2s, transform 0.2s;
        }

        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose strong { font-weight: 600; }
        .prose code { background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 0.9em; }

        .typing-dot { width: 6px; height: 6px; background-color: #AEAEB2; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-primary selection:text-white">

    <div class="scanlines"></div>

    <!-- BOOT SCREEN -->
    <div id="boot-screen" class="fixed inset-0 z-[100] bg-black flex flex-col justify-start p-8 pt-16 font-mono text-xs md:text-sm text-primary overflow-hidden tracking-wide">
        <div id="boot-log" class="space-y-1.5 opacity-90"></div>
        <div class="mt-2 animate-pulse">_</div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[90] pointer-events-none opacity-0 transition-all duration-300 transform -translate-y-4 w-auto max-w-[90%]">
        <div class="bg-surfaceHighlight/95 border border-white/10 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 backdrop-blur-md">
            <div class="w-1.5 h-1.5 rounded-full bg-primary shrink-0"></div>
            <span id="toast-message" class="text-xs font-medium tracking-wide truncate">Notification</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 transition-opacity duration-700">
        <div class="w-full max-w-sm flex flex-col items-center justify-center space-y-12">
            <div class="relative w-24 h-24 flex items-center justify-center">
                <i class="ph-fill ph-fox-logo text-7xl text-primary drop-shadow-2xl"></i>
            </div>
            <div class="text-center space-y-1">
                <h1 class="text-2xl font-bold tracking-tight text-white">f0xnet</h1>
                <p class="text-[11px] text-gray-500 font-medium tracking-widest uppercase">Secure Comms Relay</p>
            </div>
            <div class="w-full space-y-4">
                <div class="glass-input rounded-2xl px-4 py-1 flex items-center">
                    <i class="ph ph-lock-key text-gray-500 mr-3"></i>
                    <input type="password" id="login-pass" 
                        class="w-full bg-transparent text-center text-white py-3 focus:outline-none placeholder-gray-600 font-mono text-lg tracking-[0.3em]"
                        placeholder="••••••"
                        inputmode="numeric" 
                        pattern="[0-9]*"
                        autocomplete="off"
                    >
                </div>
                <button onclick="Auth.login()" class="w-full py-4 bg-primary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 active:scale-[0.98] transition-all text-sm uppercase tracking-wider">
                    Authenticate
                </button>
            </div>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="hidden h-full w-full relative">
        
        <header class="absolute top-0 left-0 right-0 z-30 glass pt-safe transition-all duration-500" id="main-header">
            <div class="h-[60px] w-full flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <div class="relative" id="avatar-btn">
                        <div class="w-9 h-9 rounded-full bg-surfaceHighlight flex items-center justify-center border border-white/5 overflow-hidden pointer-events-none">
                            <i class="ph-fill ph-user text-gray-400"></i>
                        </div>
                        <div id="status-dot" class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full bg-statusGray border-2 border-[#101010] pointer-events-none"></div>
                    </div>
                    <div class="flex flex-col justify-center">
                        <span id="contact-name" class="text-white font-semibold text-[15px] leading-tight tracking-tight">f0xnet</span>
                        <span id="connection-status" class="text-[11px] text-gray-500 font-medium leading-none mt-0.5">Offline</span>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="UI.toggleSearch()" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-white transition-colors active:bg-white/5">
                        <i class="ph ph-magnifying-glass text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Sapper Mode Pull Hint -->
        <div id="sapper-hint" class="sapper-pull-hint z-10">
            <div class="w-8 h-8 rounded-full border-2 border-primary/30 flex items-center justify-center animate-bounce">
                <i class="ph ph-caret-up text-primary"></i>
            </div>
            <span class="text-[10px] font-mono text-primary uppercase tracking-[0.2em] font-bold">Pull to Sapper</span>
        </div>

        <main id="chat-container" class="absolute inset-0 z-0 overflow-y-auto px-0 scroll-smooth no-scrollbar top-spacing bottom-spacing">
            <div id="messages-list" class="flex flex-col space-y-2 pb-2"></div>
            
            <div id="typing-indicator" class="hidden w-full px-4 flex mb-2 animate-enter-message opacity-0">
                <div class="bg-[#2C2C2E] rounded-full px-4 py-3 flex gap-1 items-center ml-0 shadow-sm">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            <div id="bottom-anchor" class="h-10"></div>
        </main>

        <footer class="absolute bottom-0 left-0 right-0 z-30 bg-[#161618]/90 backdrop-blur-xl border-t border-white/5 pb-safe" id="main-footer">
            <div id="attachment-preview" class="hidden px-4 pb-2 pt-2 flex gap-2 overflow-x-auto"></div>
            <div class="flex items-end gap-2 px-4 py-2.5 max-w-2xl mx-auto">
                <input type="file" id="media-upload" class="hidden" accept="image/*" onchange="UI.handleFileSelect(this)">
                <button onclick="document.getElementById('media-upload').click()" class="w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-full bg-surfaceHighlight text-gray-400 active:text-white transition-colors">
                    <i class="ph-bold ph-plus text-lg"></i>
                </button>
                <div class="flex-1 min-h-[36px] bg-[#1C1C1E] rounded-[18px] border border-white/5 flex items-center px-4 py-1.5 focus-within:border-primary/50 transition-colors">
                    <textarea id="message-input" rows="1" class="w-full bg-transparent text-white placeholder-[#8E8E93] focus:outline-none resize-none max-h-24 text-[16px] leading-tight py-1.5" placeholder="Message" oninput="UI.autoResize(this)"></textarea>
                </div>
                <button onclick="Chat.send()" id="send-btn" class="w-9 h-9 flex-shrink-0 rounded-full bg-primary text-white flex items-center justify-center shadow-md active:scale-90 transition-transform disabled:opacity-50">
                    <i class="ph-bold ph-arrow-up text-lg"></i>
                </button>
            </div>
        </footer>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60]">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="UI.toggleSettings()"></div>
        <div class="absolute bottom-0 left-0 right-0 glass-modal rounded-t-[32px] max-h-[90vh] overflow-hidden flex flex-col shadow-2xl animate-slide-up-modal ring-1 ring-white/10">
            <div class="w-full flex justify-center pt-3 pb-2" onclick="UI.toggleSettings()">
                <div class="w-10 h-1 bg-gray-600/40 rounded-full"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-12">
                <h2 class="text-lg font-semibold text-white">System Config</h2>
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Uplink Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none font-mono" placeholder="API KEY">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Neural Model</label>
                        <select id="model-select" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none appearance-none">
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Contact ID</label>
                        <input type="text" id="ai-name-input" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Protocol Rules</label>
                        <textarea id="system-prompt" rows="3" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-sm text-gray-300 font-mono focus:border-primary focus:outline-none"></textarea>
                    </div>
                </div>
                <button onclick="Settings.save()" class="w-full py-4 bg-white text-black font-semibold rounded-xl shadow-lg active:scale-[0.98] transition-transform">Save Changes</button>
                <div class="text-center"><button onclick="Settings.wipeData()" class="text-xs text-red-500 font-medium py-2">Factory Reset</button></div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULTS = {
            aiName: "f0xnet",
            systemPrompt: "You are a secure contact. Keep messages concise and natural. Use lowercase occasionally. You are aware of the user's local time and date. Occasionally make subtle, realistic comments about the time (e.g., 'up late?', 'early start', etc) but don't force it.",
            model: "gemini-1.5-flash",
            apiKey: "",
            password: "",
            lastActive: Date.now(),
            sapperMode: false
        };

        const State = {
            config: { ...DEFAULTS },
            history: [],
            isFirstLoad: true,
            attachment: null,
            tapCount: 0,
            tapTimer: null,
            swipeStartX: 0,
            isSwiping: false,

            load() {
                const c = localStorage.getItem('f0x_config_v6');
                const h = localStorage.getItem('f0x_history_v6');
                if(c) { this.config = JSON.parse(c); this.isFirstLoad = false; }
                if(h) { this.history = JSON.parse(h); }
            },
            save() {
                localStorage.setItem('f0x_config_v6', JSON.stringify(this.config));
                localStorage.setItem('f0x_history_v6', JSON.stringify(this.history));
            }
        };

        const UI = {
            els: {
                app: document.getElementById('app-interface'),
                login: document.getElementById('login-screen'),
                msgList: document.getElementById('messages-list'),
                scroll: document.getElementById('chat-container'),
                input: document.getElementById('message-input'),
                hint: document.getElementById('sapper-hint')
            },

            haptic(force = 5) { if (navigator.vibrate) navigator.vibrate(force); },

            showApp() {
                this.els.login.style.opacity = '0';
                setTimeout(() => {
                    this.els.login.classList.add('hidden');
                    this.els.app.classList.remove('hidden');
                    this.refresh();
                    this.initGestures();
                    this.initAvatarStealth();
                    this.updateSapperUI();
                }, 700);
            },

            initGestures() {
                const el = this.els.scroll;
                let startY = 0;
                
                // --- Swipe Right Reveal Timestamps ---
                el.addEventListener('touchstart', e => {
                    this.swipeStartX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    this.isSwiping = false;
                }, {passive: true});

                el.addEventListener('touchmove', e => {
                    const x = e.touches[0].clientX;
                    const y = e.touches[0].clientY;
                    const diffX = this.swipeStartX - x;
                    const diffY = startY - y;

                    // iMessage swipe reveal (dragging left to reveal right)
                    if (diffX > 10 && Math.abs(diffX) > Math.abs(diffY)) {
                        this.isSwiping = true;
                        const offset = Math.min(diffX, 65);
                        document.querySelectorAll('.message-row').forEach(row => {
                            row.style.transform = `translateX(-${offset}px)`;
                        });
                        this.els.msgList.classList.add('swiping');
                    }

                    // Sapper Pull (at bottom)
                    const isAtBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 20;
                    if(isAtBottom && diffY > 30) {
                        const progress = Math.min((diffY - 30) / 100, 1);
                        this.els.hint.style.opacity = progress;
                        this.els.hint.style.transform = `translateY(${20 - (progress * 20)}px)`;
                        if(progress === 1 && !this.sapperTriggered) {
                            this.sapperTriggered = true;
                            this.toggleSapperMode();
                        }
                    }
                }, {passive: true});

                el.addEventListener('touchend', () => {
                    // Reset swipe reveal
                    document.querySelectorAll('.message-row').forEach(row => {
                        row.style.transform = `translateX(0)`;
                    });
                    this.els.msgList.classList.remove('swiping');
                    this.els.hint.style.opacity = 0;
                    this.sapperTriggered = false;
                });
            },

            initAvatarStealth() {
                document.getElementById('avatar-btn').addEventListener('click', () => {
                    this.haptic();
                    State.tapCount++;
                    if(State.tapTimer) clearTimeout(State.tapTimer);
                    if(State.tapCount >= 3) {
                        this.toggleSettings();
                        State.tapCount = 0;
                    } else {
                        State.tapTimer = setTimeout(() => State.tapCount = 0, 500);
                    }
                });
            },

            toggleSapperMode() {
                this.haptic(40);
                State.config.sapperMode = !State.config.sapperMode;
                State.save();
                this.updateSapperUI();
                UI.toast(`Sapper Mode ${State.config.sapperMode ? 'Active' : 'Disabled'}`);
                if(State.config.sapperMode) {
                    this.renderMsg('system', 'Self-destruct protocol engaged. Messages vanish after 60s.');
                }
            },

            updateSapperUI() {
                if(State.config.sapperMode) document.body.classList.add('sapper-mode-active');
                else document.body.classList.remove('sapper-mode-active');
            },

            refresh() {
                document.getElementById('contact-name').textContent = State.config.aiName;
                document.getElementById('api-key-input').value = State.config.apiKey || '';
                document.getElementById('ai-name-input').value = State.config.aiName;
                document.getElementById('system-prompt').value = State.config.systemPrompt;
                this.renderHistory(State.history);
            },

            renderHistory(msgs) {
                this.els.msgList.innerHTML = '';
                const now = Date.now();
                const validMsgs = msgs.filter(m => !m.expiresAt || m.expiresAt > now);
                if(validMsgs.length !== msgs.length) { State.history = validMsgs; State.save(); }
                validMsgs.forEach((msg, i) => this.renderMsg(msg.role, msg.text, false, msg, i === validMsgs.length - 1));
                this.scrollToBottom();
            },

            renderMsg(role, text, animate = true, msgObj = null, isLast = true) {
                const row = document.createElement('div');
                row.className = `message-row ${isLast && role === 'user' ? 'last-user-msg' : ''}`;
                
                const timeStr = new Date(msgObj?.id || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                if(msgObj?.expiresAt) {
                    const timeLeft = msgObj.expiresAt - Date.now();
                    setTimeout(() => { row.classList.add('animate-fade-out'); setTimeout(() => row.remove(), 1000); }, timeLeft);
                }

                if(role === 'system') {
                    row.innerHTML = `<div class="msg-system animate-fade-in">${text}</div>`;
                } else {
                    const isUser = role === 'user';
                    row.innerHTML = `
                        <div class="msg-bubble-container px-4">
                            <div class="msg-bubble ${isUser ? 'msg-user' : 'msg-ai'} ${animate ? 'animate-enter-message' : ''}">
                                <div class="prose prose-invert prose-sm leading-relaxed">${marked.parse(text)}</div>
                            </div>
                            ${isUser ? `<div class="msg-status-line" id="status-${msgObj?.id}">Sent</div>` : ''}
                        </div>
                        <div class="msg-timestamp-reveal">${timeStr}</div>
                    `;
                }
                this.els.msgList.appendChild(row);
                this.scrollToBottom();
                return row;
            },

            updateStatus(status) {
                const el = document.querySelector('.last-user-msg .msg-status-line');
                if(el) el.textContent = status;
            },

            scrollToBottom() { setTimeout(() => { this.els.scroll.scrollTop = this.els.scroll.scrollHeight; }, 50); },
            showTyping(show) {
                const ind = document.getElementById('typing-indicator');
                if(show) { ind.classList.remove('hidden', 'opacity-0'); this.updateStatus('Seen'); this.scrollToBottom(); }
                else { ind.classList.add('hidden', 'opacity-0'); }
            },

            toggleSettings() { this.haptic(); document.getElementById('settings-modal').classList.toggle('hidden'); },
            toggleSearch() { this.haptic(); UI.toast("Neural Search: WIP"); },
            
            handleFileSelect(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    State.attachment = { mimeType: file.type, data: e.target.result.split(',')[1], url: e.target.result };
                    const preview = document.getElementById('attachment-preview');
                    preview.classList.remove('hidden');
                    preview.innerHTML = `<div class="relative"><img src="${e.target.result}" class="h-16 w-16 object-cover rounded-xl border border-white/20"><button onclick="UI.clearAttachment()" class="absolute -top-1.5 -right-1.5 bg-gray-800 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="ph ph-x"></i></button></div>`;
                };
                reader.readAsDataURL(file);
            },
            clearAttachment() { State.attachment = null; document.getElementById('attachment-preview').classList.add('hidden'); },
            autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; },
            toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-message').textContent = msg;
                t.classList.remove('opacity-0', '-translate-y-4'); t.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => { t.classList.remove('opacity-100', 'translate-y-0'); t.classList.add('opacity-0', '-translate-y-4'); }, 3000);
            }
        };

        const Chat = {
            async send() {
                UI.haptic();
                const input = document.getElementById('message-input');
                const txt = input.value.trim();
                if(!txt && !State.attachment) return;
                
                input.value = ''; input.style.height = 'auto';
                
                let displayText = txt;
                let activeAttachment = State.attachment;
                if(activeAttachment) { displayText = `![Image](${activeAttachment.url})\n\n${txt}`; UI.clearAttachment(); }

                const expiresAt = State.config.sapperMode ? Date.now() + 60000 : null;
                const msgData = { role: 'user', text: displayText, id: Date.now(), expiresAt };

                // Clean up previous "last user msg" class
                document.querySelectorAll('.last-user-msg').forEach(m => m.classList.remove('last-user-msg'));

                State.history.push(msgData);
                State.save();
                UI.renderMsg('user', displayText, true, msgData, true);
                Status.setOnline();

                setTimeout(() => UI.updateStatus('Delivered'), 1500);
                
                const readDelay = Math.random() * 3000 + 4000;
                await new Promise(r => setTimeout(r, readDelay));
                this.fetchReply(activeAttachment);
            },

            async fetchReply(attachment) {
                try {
                    const localTime = new Date().toLocaleString();
                    const context = State.history.slice(-15).filter(m => m.role !== 'system').map(m => {
                        let text = m.text;
                        if(text.startsWith('![Image]')) text = text.split('\n\n')[1] || "[Image]";
                        return { role: m.role === 'user' ? 'user' : 'model', parts: [{ text }] };
                    });
                    
                    context.pop(); 
                    const currentParts = [{ text: `[Current Local Context: ${localTime}] ${State.history[State.history.length-1].text}` }];
                    if(attachment) currentParts.push({ inlineData: { mimeType: attachment.mimeType, data: attachment.data }});

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${State.config.model}:generateContent?key=${State.config.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [...context, { role: 'user', parts: currentParts }], systemInstruction: { parts: [{ text: State.config.systemPrompt }] }})
                    });

                    const data = await res.json();
                    if(!res.ok) throw new Error("Link Failed");

                    const reply = data.candidates[0].content.parts[0].text;
                    const typingTime = Math.min(Math.max(reply.length * 35, 2000), 10000);

                    UI.showTyping(true);
                    await new Promise(r => setTimeout(r, typingTime));
                    UI.showTyping(false);

                    const expiresAt = State.config.sapperMode ? Date.now() + 60000 : null;
                    const aiMsg = { role: 'model', text: reply, id: Date.now(), expiresAt };
                    State.history.push(aiMsg);
                    State.save();
                    UI.renderMsg('model', reply, true, aiMsg);
                    UI.haptic(10);
                    Status.setOnline();
                } catch(e) { UI.showTyping(false); UI.toast("Error: Handshake Broken"); }
            }
        };

        const Auth = {
            init() { document.getElementById('login-screen').classList.remove('hidden'); Status.startLoop(); },
            login() { UI.haptic(); UI.showApp(); }
        };

        const Status = {
            startLoop() { this.update(); setInterval(() => this.update(), 60000); },
            update() {
                const elText = document.getElementById('connection-status');
                const elDot = document.getElementById('status-dot');
                const diff = (Date.now() - State.config.lastActive) / 60000;
                if (diff < 5) { elText.textContent = "Online"; elDot.style.backgroundColor = "#34C759"; }
                else if (diff < 30) { elText.textContent = "Idle"; elDot.style.backgroundColor = "#FFD60A"; }
                else { elText.textContent = "Offline"; elDot.style.backgroundColor = "#8E8E93"; }
            },
            setOnline() { State.config.lastActive = Date.now(); State.save(); this.update(); }
        };

        const Settings = {
            save() {
                State.config.apiKey = document.getElementById('api-key-input').value.trim();
                State.config.aiName = document.getElementById('ai-name-input').value.trim() || DEFAULTS.aiName;
                State.config.systemPrompt = document.getElementById('system-prompt').value.trim();
                State.save(); UI.refresh(); UI.toggleSettings(); UI.toast("Protocol Updated");
            },
            wipeData() { if(confirm("Purge Storage?")) { localStorage.clear(); location.reload(); } }
        };

        document.addEventListener('DOMContentLoaded', () => { State.load(); Auth.init(); });
    </script>
</body>
</html>