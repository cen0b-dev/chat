<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>f0xnet // Secure</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#000000',
                        surface: '#0F0F0F',
                        surfaceHighlight: '#1C1C1E',
                        primary: '#D14E42', // Custom Red
                        primaryDim: '#8A2C23',
                        statusGreen: '#34C759',
                        statusYellow: '#FFD60A',
                        statusGray: '#8E8E93',
                    },
                    fontFamily: {
                        sans: ['SF Pro Text', '-apple-system', 'BlinkMacSystemFont', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'SF Mono', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'enter-message': 'enterMessage 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards',
                        'slide-up-modal': 'slideUpModal 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        enterMessage: {
                            '0%': { opacity: '0', transform: 'translateY(15px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        slideUpModal: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            font-feature-settings: "ss01", "ss02";
        }

        /* Scanline Overlay */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.02));
            background-size: 100% 3px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.3;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-modal {
            background: rgba(22, 22, 24, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .glass-input {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, textarea, select { font-size: 16px !important; } 

        /* Message Bubbles */
        .msg-bubble {
            position: relative;
            max-width: 78%;
            padding: 10px 16px;
            font-size: 16px;
            line-height: 1.45;
            letter-spacing: -0.015em;
        }
        
        .msg-user {
            background-color: #D14E42;
            color: white;
            border-radius: 20px 20px 4px 20px;
            margin-left: auto;
        }
        
        .msg-ai {
            background-color: #2C2C2E;
            color: #F2F2F7;
            border-radius: 20px 20px 20px 4px;
            margin-right: auto;
        }

        .msg-system {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 11px;
            color: #8E8E93;
            text-align: center;
            width: 100%;
            padding: 12px 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose strong { font-weight: 600; }
        .prose code { 
            background: rgba(0,0,0,0.3); 
            padding: 2px 4px; 
            border-radius: 4px; 
            font-family: 'SF Mono', monospace; 
            font-size: 0.9em; 
        }

        /* Typing Dots */
        .typing-dot {
            width: 6px; height: 6px;
            background-color: #AEAEB2;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-primary selection:text-white">

    <div class="scanlines"></div>

    <!-- BOOT SCREEN -->
    <div id="boot-screen" class="fixed inset-0 z-[100] bg-black flex flex-col justify-start p-8 pt-16 font-mono text-xs md:text-sm text-primary overflow-hidden tracking-wide">
        <div id="boot-log" class="space-y-1.5 opacity-90"></div>
        <div class="mt-2 animate-pulse">_</div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[90] pointer-events-none opacity-0 transition-all duration-300 transform -translate-y-4 w-auto max-w-[90%]">
        <div class="bg-surfaceHighlight/95 border border-white/10 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 backdrop-blur-md">
            <div class="w-1.5 h-1.5 rounded-full bg-primary shrink-0"></div>
            <span id="toast-message" class="text-xs font-medium tracking-wide truncate">Notification</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 transition-opacity duration-700">
        <div class="w-full max-w-sm flex flex-col items-center space-y-10">
            <!-- Logo -->
            <div class="relative w-24 h-24 flex items-center justify-center mb-4">
                <i class="ph-fill ph-fox-logo text-7xl text-primary drop-shadow-2xl"></i>
            </div>
            
            <div class="text-center space-y-1">
                <h1 class="text-2xl font-bold tracking-tight text-white">f0xnet</h1>
                <p class="text-[11px] text-gray-500 font-medium tracking-widest uppercase">Secure Comms Relay</p>
            </div>
            
            <!-- Glass Input -->
            <div class="w-full space-y-4">
                <div class="glass-input rounded-2xl px-4 py-1 flex items-center">
                    <i class="ph ph-lock-key text-gray-500 mr-3"></i>
                    <input type="password" id="login-pass" 
                        class="w-full bg-transparent text-center text-white py-3 focus:outline-none placeholder-gray-600 font-mono text-lg tracking-[0.3em]"
                        placeholder="••••••"
                        inputmode="numeric" 
                        pattern="[0-9]*"
                        autocomplete="off"
                    >
                </div>
                <button onclick="Auth.login()" class="w-full py-4 bg-primary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 active:scale-[0.98] transition-all text-sm uppercase tracking-wider">
                    Authenticate
                </button>
            </div>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="hidden flex-col h-full bg-background relative z-10">
        
        <!-- Header -->
        <header class="glass h-[60px] flex items-center justify-between px-4 fixed top-0 w-full z-30 pt-safe-top transition-all duration-300" id="main-header">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-9 h-9 rounded-full bg-surfaceHighlight flex items-center justify-center border border-white/5 overflow-hidden">
                        <i class="ph-fill ph-user text-gray-400"></i>
                    </div>
                    <!-- Status Dot -->
                    <div id="status-dot" class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full bg-statusGray border-2 border-[#101010]"></div>
                </div>
                <div class="flex flex-col justify-center">
                    <span id="contact-name" class="text-white font-semibold text-[15px] leading-tight tracking-tight">f0xnet</span>
                    <span id="connection-status" class="text-[11px] text-gray-500 font-medium leading-none mt-0.5">Offline</span>
                </div>
            </div>
            
            <div class="flex items-center gap-1">
                <button onclick="UI.toggleSearch()" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-white transition-colors active:bg-white/5">
                    <i class="ph ph-magnifying-glass text-xl"></i>
                </button>
                <button onclick="UI.toggleSettings()" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-white transition-colors active:bg-white/5">
                    <i class="ph-fill ph-list text-xl"></i>
                </button>
            </div>
        </header>

        <!-- Search Bar (Hidden by default) -->
        <div id="search-bar-container" class="hidden fixed top-[60px] left-0 right-0 z-20 bg-black/80 backdrop-blur-md border-b border-white/5 px-4 py-2 pt-safe-top animate-fade-in">
            <div class="glass-input rounded-xl flex items-center px-3 py-2">
                <i class="ph ph-magnifying-glass text-gray-500 mr-2"></i>
                <input type="text" id="search-input" placeholder="Search history..." class="w-full bg-transparent text-white text-sm focus:outline-none" oninput="UI.handleSearch(this.value)">
                <button onclick="UI.toggleSearch()" class="text-gray-500 ml-2"><i class="ph-bold ph-x"></i></button>
            </div>
        </div>

        <!-- Chat Container -->
        <main id="chat-container" class="flex-1 overflow-y-auto px-4 pt-[60px] pb-[80px] scroll-smooth no-scrollbar">
            <div class="h-4"></div>
            <div id="messages-list" class="flex flex-col space-y-2 pb-2"></div>
            
            <!-- Realistic Typing Indicator -->
            <div id="typing-indicator" class="hidden w-full flex mb-2 animate-enter-message opacity-0">
                <div class="bg-[#2C2C2E] rounded-full px-4 py-3 flex gap-1 items-center ml-0 shadow-sm">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            <div id="bottom-anchor" class="h-2"></div>
        </main>

        <!-- Input Bar -->
        <footer class="fixed bottom-0 w-full z-30 bg-[#161618]/90 backdrop-blur-xl border-t border-white/5 pb-safe-bottom">
            <div class="flex items-end gap-3 px-4 py-3 max-w-2xl mx-auto">
                <button class="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full bg-surfaceHighlight text-gray-400 active:text-white transition-colors">
                    <i class="ph ph-plus text-lg"></i>
                </button>
                <div class="flex-1 min-h-[36px] bg-[#1C1C1E] rounded-[18px] border border-white/5 flex items-center px-4 py-1.5 focus-within:border-primary/50 transition-colors">
                    <textarea id="message-input" rows="1" 
                        class="w-full bg-transparent text-white placeholder-[#8E8E93] focus:outline-none resize-none max-h-24 text-[16px] leading-tight py-1.5"
                        placeholder="Message"
                        oninput="UI.autoResize(this)"
                        onkeydown="UI.handleEnter(event)"
                    ></textarea>
                </div>
                <button onclick="Chat.send()" id="send-btn" 
                    class="w-8 h-8 flex-shrink-0 rounded-full bg-primary text-white flex items-center justify-center shadow-md active:scale-90 transition-transform">
                    <i class="ph-bold ph-arrow-up text-sm"></i>
                </button>
            </div>
        </footer>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60]">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="UI.toggleSettings()"></div>
        <div class="absolute bottom-0 left-0 right-0 glass-modal rounded-t-[32px] max-h-[90vh] overflow-hidden flex flex-col shadow-2xl animate-slide-up-modal ring-1 ring-white/10">
            
            <div class="w-full flex justify-center pt-3 pb-2" onclick="UI.toggleSettings()">
                <div class="w-10 h-1 bg-gray-600/40 rounded-full"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-12">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-semibold text-white">System Config</h2>
                    <button onclick="UI.toggleSettings()" class="w-8 h-8 rounded-full bg-surfaceHighlight flex items-center justify-center text-gray-400">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <!-- API Key -->
                <div class="space-y-2">
                    <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Uplink Key</label>
                    <input type="password" id="api-key-input" 
                        class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none font-mono" 
                        placeholder="Paste Gemini API Key"
                        oninput="Settings.handleKeyInput(this.value)">
                </div>

                <!-- Model Selector -->
                <div class="space-y-2">
                    <div class="flex justify-between px-1">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Neural Model</label>
                        <span id="model-status" class="text-[10px] text-gray-500">Standby</span>
                    </div>
                    <div class="relative">
                        <select id="model-select" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none appearance-none">
                            <option value="" disabled selected>Waiting for Key...</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                            <i class="ph-bold ph-caret-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Persona -->
                <div class="space-y-4 pt-2">
                    <div class="space-y-2">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Contact ID</label>
                        <input type="text" id="ai-name-input" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none" placeholder="f0xnet">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Protocol Rules</label>
                        <textarea id="system-prompt" rows="3" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-sm text-gray-300 font-mono focus:border-primary focus:outline-none" placeholder="Instruction set..."></textarea>
                    </div>
                </div>

                <!-- Actions -->
                <button onclick="Settings.save()" class="w-full py-4 bg-white text-black font-semibold rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                    Save Changes
                </button>
                
                <div class="text-center pt-2">
                    <button onclick="Settings.wipeData()" class="text-xs text-red-500 font-medium py-2 px-4 rounded-lg hover:bg-red-500/10">Factory Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const DEFAULTS = {
            aiName: "f0xnet",
            systemPrompt: "You are a secure contact. Keep messages concise and natural. Use lowercase occasionally. Don't sound robotic.",
            model: "gemini-1.5-flash",
            apiKey: "",
            password: "",
            lastActive: Date.now()
        };

        const State = {
            config: { ...DEFAULTS },
            history: [],
            isFirstLoad: true,

            load() {
                const c = localStorage.getItem('f0x_config_v4');
                const h = localStorage.getItem('f0x_history_v4');
                if(c) { this.config = JSON.parse(c); this.isFirstLoad = false; }
                if(h) { this.history = JSON.parse(h); }
            },
            save() {
                localStorage.setItem('f0x_config_v4', JSON.stringify(this.config));
                localStorage.setItem('f0x_history_v4', JSON.stringify(this.history));
            },
            reset() {
                localStorage.clear();
                location.reload();
            }
        };

        const Boot = {
            log: document.getElementById('boot-log'),
            screen: document.getElementById('boot-screen'),
            
            async run() {
                if(!State.isFirstLoad) {
                    this.screen.classList.add('hidden');
                    Auth.init();
                    return;
                }

                const lines = [
                    "ESTABLISHING SECURE HANDSHAKE...",
                    "VERIFYING KEYS...",
                    "DECRYPTING STORAGE...",
                    "CONNECTION SECURE."
                ];
                
                for(let line of lines) {
                    const p = document.createElement('div');
                    p.textContent = `> ${line}`;
                    this.log.appendChild(p);
                    await new Promise(r => setTimeout(r, 400));
                }

                await new Promise(r => setTimeout(r, 400));
                this.screen.style.opacity = '0';
                setTimeout(() => {
                    this.screen.classList.add('hidden');
                    Auth.init();
                }, 500);
            }
        };

        const Auth = {
            init() {
                document.getElementById('login-screen').classList.remove('hidden');
                if(State.config.password) {
                    setTimeout(() => document.getElementById('login-pass').focus(), 100);
                }
                if(State.config.apiKey) Settings.fetchModels(State.config.apiKey);
                Status.startLoop();
            },
            login() {
                const input = document.getElementById('login-pass');
                const val = input.value.trim();
                
                if(State.isFirstLoad) {
                    if(!val) return;
                    State.config.password = val;
                    State.save();
                    UI.showApp();
                } else {
                    if(val === State.config.password) UI.showApp();
                    else {
                        input.value = '';
                        input.classList.add('text-primary');
                        setTimeout(() => input.classList.remove('text-primary'), 500);
                    }
                }
            }
        };

        const Status = {
            startLoop() {
                this.update();
                setInterval(() => this.update(), 60000); // Check every minute
            },
            update() {
                const elText = document.getElementById('connection-status');
                const elDot = document.getElementById('status-dot');
                
                const now = Date.now();
                const diff = (now - State.config.lastActive) / 1000 / 60; // minutes

                if (diff < 5) {
                    elText.textContent = "Online";
                    elDot.style.backgroundColor = "#34C759"; // Green
                } else if (diff < 30) {
                    elText.textContent = "Idle";
                    elDot.style.backgroundColor = "#FFD60A"; // Yellow
                } else {
                    elText.textContent = "Offline";
                    elDot.style.backgroundColor = "#8E8E93"; // Gray
                }
            },
            setOnline() {
                State.config.lastActive = Date.now();
                State.save();
                this.update();
            }
        };

        const UI = {
            els: {
                app: document.getElementById('app-interface'),
                login: document.getElementById('login-screen'),
                msgList: document.getElementById('messages-list'),
                scroll: document.getElementById('chat-container'),
                input: document.getElementById('message-input'),
                search: document.getElementById('search-bar-container')
            },

            showApp() {
                this.els.login.style.opacity = '0';
                setTimeout(() => {
                    this.els.login.classList.add('hidden');
                    this.els.app.classList.remove('hidden');
                    this.els.app.classList.add('flex');
                    this.refresh();
                    if(!State.config.apiKey) setTimeout(() => this.toggleSettings(), 600);
                }, 700);
            },

            refresh() {
                document.getElementById('contact-name').textContent = State.config.aiName;
                document.getElementById('api-key-input').value = State.config.apiKey || '';
                document.getElementById('ai-name-input').value = State.config.aiName;
                document.getElementById('system-prompt').value = State.config.systemPrompt;
                
                const select = document.getElementById('model-select');
                if(State.config.model && select.querySelector(`option[value="${State.config.model}"]`)) {
                    select.value = State.config.model;
                }

                this.renderHistory(State.history);
            },

            renderHistory(msgs) {
                this.els.msgList.innerHTML = '';
                msgs.forEach(msg => this.renderMsg(msg.role, msg.text, false));
                this.scrollToBottom();
            },

            renderMsg(role, text, animate = true) {
                const div = document.createElement('div');
                if(role === 'system') {
                    div.className = 'msg-system animate-fade-in';
                    div.textContent = text;
                } else {
                    div.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-ai'} ${animate ? 'animate-enter-message' : ''}`;
                    const html = marked.parse(text);
                    div.innerHTML = `<div class="prose prose-invert prose-sm leading-relaxed">${html}</div>`;
                }
                this.els.msgList.appendChild(div);
                this.scrollToBottom();
            },

            scrollToBottom() {
                setTimeout(() => {
                    this.els.scroll.scrollTop = this.els.scroll.scrollHeight;
                }, 50);
            },

            showTyping(show) {
                const ind = document.getElementById('typing-indicator');
                if(show) {
                    ind.classList.remove('hidden', 'opacity-0');
                    this.scrollToBottom();
                } else {
                    ind.classList.add('hidden', 'opacity-0');
                }
            },

            toggleSettings() {
                document.getElementById('settings-modal').classList.toggle('hidden');
            },

            toggleSearch() {
                this.els.search.classList.toggle('hidden');
                if(!this.els.search.classList.contains('hidden')) {
                    document.getElementById('search-input').focus();
                } else {
                    this.renderHistory(State.history);
                }
            },

            handleSearch(query) {
                if(!query) {
                    this.renderHistory(State.history);
                    return;
                }
                const filtered = State.history.filter(m => m.text.toLowerCase().includes(query.toLowerCase()));
                this.els.msgList.innerHTML = '';
                filtered.forEach(msg => this.renderMsg(msg.role, msg.text, false));
            },

            toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-message').textContent = msg;
                t.classList.remove('opacity-0', '-translate-y-4');
                t.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    t.classList.remove('opacity-100', 'translate-y-0');
                    t.classList.add('opacity-0', '-translate-y-4');
                }, 3500);
            },

            autoResize(el) {
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, 100) + 'px';
            },

            handleEnter(e) {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    Chat.send();
                }
            }
        };

        const Chat = {
            async send() {
                const input = UI.els.input;
                const txt = input.value.trim();
                if(!txt) return;
                
                if(!State.config.apiKey) {
                    UI.toggleSettings();
                    return UI.toast("Error: Missing Uplink Key");
                }

                input.value = '';
                input.style.height = 'auto';
                input.blur();

                // 1. User Message
                State.history.push({role: 'user', text: txt});
                State.save();
                UI.renderMsg('user', txt);
                Status.setOnline();

                // 2. Realistic "Reading" Latency (5-10s)
                const humanLatency = Math.floor(Math.random() * (10000 - 5000 + 1) + 5000);
                
                await new Promise(r => setTimeout(r, humanLatency));

                // 3. Start Fetch & Typing Sequence
                this.fetchReply();
            },

            async fetchReply() {
                try {
                    const context = State.history.slice(-15).filter(m => m.role !== 'system').map(m => ({
                        role: m.role === 'user' ? 'user' : 'model',
                        parts: [{ text: m.text }]
                    }));

                    // Fetch Content
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${State.config.model}:generateContent?key=${State.config.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: context,
                            systemInstruction: { parts: [{ text: State.config.systemPrompt }] }
                        })
                    });

                    const data = await res.json();

                    // Check for Protocol Errors
                    if(!res.ok) {
                        throw new Error(data.error?.message || "Protocol Error: " + res.status);
                    }
                    
                    if(!data.candidates?.[0]?.content) {
                        if(data.promptFeedback?.blockReason) throw new Error("Connection Refused: Content Filtered");
                        throw new Error("Connection Refused: Empty Payload");
                    }

                    const reply = data.candidates[0].content.parts[0].text;

                    // 4. Simulate Typing Time based on length
                    const chars = reply.length;
                    const baseTime = chars * 40; // 40ms per char
                    const typingTime = Math.min(Math.max(baseTime, 1500), 12000); // 1.5s - 12s

                    UI.showTyping(true);

                    // Hesitation Effect for long messages
                    if(typingTime > 5000) {
                        await new Promise(r => setTimeout(r, typingTime * 0.4));
                        UI.showTyping(false); 
                        await new Promise(r => setTimeout(r, 1200)); 
                        UI.showTyping(true);
                        await new Promise(r => setTimeout(r, typingTime * 0.6));
                    } else {
                        await new Promise(r => setTimeout(r, typingTime));
                    }

                    UI.showTyping(false);
                    State.history.push({role: 'model', text: reply});
                    State.save();
                    UI.renderMsg('model', reply);
                    Status.setOnline();

                } catch(e) {
                    UI.showTyping(false);
                    console.error(e);
                    
                    let errorMsg = "Secure Handshake Failed";
                    if(e.message.includes('400')) errorMsg = "Authorization Failed: Invalid Key";
                    if(e.message.includes('403')) errorMsg = "Access Denied: Region Locked";
                    if(e.message.includes('429')) errorMsg = "Network Congestion: Too Many Requests";
                    if(e.message.includes('Content Filtered')) errorMsg = "Transmission Blocked: Safety Protocol";
                    
                    UI.toast(errorMsg);
                    
                    // Optional: System Log
                    // State.history.push({role: 'system', text: `ERROR: ${errorMsg}`});
                    // UI.renderMsg('system', `ERROR: ${errorMsg}`);
                }
            }
        };

        const Settings = {
            debounceTimer: null,

            handleKeyInput(val) {
                if(this.debounceTimer) clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    if(val.length > 20) this.fetchModels(val);
                }, 800);
            },

            async fetchModels(key) {
                const select = document.getElementById('model-select');
                const status = document.getElementById('model-status');
                
                status.textContent = "Scanning...";
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    const data = await res.json();

                    if(data.models) {
                        select.innerHTML = '';
                        const valid = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                        
                        valid.forEach(m => {
                            const name = m.name.replace('models/', '');
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.text = name;
                            select.appendChild(opt);
                        });

                        // Smart Select
                        if(State.config.model && valid.some(m => m.name.includes(State.config.model))) {
                            select.value = State.config.model;
                        } else if(valid.some(m => m.name.includes('gemini-1.5-flash'))) {
                            select.value = valid.find(m => m.name.includes('gemini-1.5-flash')).name.replace('models/', '');
                        } else {
                            select.selectedIndex = 0;
                        }
                        
                        State.config.model = select.value;
                        status.textContent = "Verified";
                        status.className = "text-[10px] text-green-500";
                    }
                } catch(e) {
                    status.textContent = "Error";
                    status.className = "text-[10px] text-red-500";
                }
            },

            save() {
                State.config.apiKey = document.getElementById('api-key-input').value.trim();
                State.config.aiName = document.getElementById('ai-name-input').value.trim() || DEFAULTS.aiName;
                State.config.systemPrompt = document.getElementById('system-prompt').value.trim();
                State.config.model = document.getElementById('model-select').value;
                
                State.save();
                UI.refresh();
                UI.toggleSettings();
                
                const updateMsg = `SECURE LOG: Protocol updated.`;
                State.history.push({role: 'system', text: updateMsg});
                UI.renderMsg('system', updateMsg);
                
                UI.toast("Settings Encrypted & Saved");
            },

            wipeData() {
                if(confirm("Confirm Wipe? Action is irreversible.")) State.reset();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            State.load();
            marked.setOptions({ breaks: true, gfm: true });
            Boot.run();
        });
    </script>
</body>
</html>