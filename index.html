<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>f0xnet // Secure</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#000000',
                        surface: '#0F0F0F',
                        surfaceHighlight: '#1C1C1E',
                        primary: '#D14E42', // Custom Red
                        primaryDim: '#8A2C23',
                        statusGreen: '#34C759',
                        statusYellow: '#FFD60A',
                        statusGray: '#8E8E93',
                    },
                    fontFamily: {
                        sans: ['SF Pro Text', '-apple-system', 'BlinkMacSystemFont', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'SF Mono', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'enter-message': 'enterMessage 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards',
                        'slide-up-modal': 'slideUpModal 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'fade-out': 'fadeOut 1s ease-out forwards',
                        'pulse-slow': 'pulseSlow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        enterMessage: {
                            '0%': { opacity: '0', transform: 'translateY(15px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        slideUpModal: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', filter: 'blur(0px)' },
                            '100%': { opacity: '0', filter: 'blur(4px)' },
                        },
                        pulseSlow: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CRITICAL: iOS PWA Layout Fixes */
        html, body {
            background-color: #000000;
            color: #ffffff;
            position: fixed; 
            width: 100%;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            font-feature-settings: "ss01", "ss02";
            overscroll-behavior-y: none;
        }

        /* Scanline Overlay */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.02));
            background-size: 100% 3px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.3;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-modal {
            background: rgba(22, 22, 24, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .glass-input {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, textarea, select { font-size: 16px !important; } 

        /* iOS Safe Area Padding Helpers */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Calculated Layout Spacing */
        .top-spacing { padding-top: calc(60px + env(safe-area-inset-top)); }
        .bottom-spacing { padding-bottom: calc(70px + env(safe-area-inset-bottom)); }

        .search-offset-top {
            top: calc(60px + env(safe-area-inset-top));
        }

        /* Message Layout System */
        .msg-row {
            display: flex;
            width: 100%;
            position: relative;
            align-items: flex-end;
            margin-bottom: 2px;
        }
        
        /* Message Bubbles */
        .msg-bubble {
            position: relative;
            max-width: 78%;
            padding: 10px 14px;
            font-size: 16px;
            line-height: 1.45;
            letter-spacing: -0.015em;
            z-index: 2;
        }
        
        .msg-user {
            background-color: #D14E42;
            color: white;
            border-radius: 20px 20px 4px 20px;
            margin-left: auto;
        }
        
        .msg-ai {
            background-color: #2C2C2E;
            color: #F2F2F7;
            border-radius: 20px 20px 20px 4px;
            margin-right: auto;
        }

        .msg-system {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 10px;
            color: #555;
            text-align: center;
            width: 100%;
            padding: 12px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Timestamp Column (Hidden by default, revealed on drag) */
        .timestamp-col {
            position: absolute;
            right: -60px; /* Hidden offscreen */
            top: 0;
            bottom: 0;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-size: 11px;
            color: #636366;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Status Line (Delivered/Seen) */
        .status-line {
            width: 100%;
            text-align: right;
            font-size: 11px;
            color: #8E8E93;
            padding-right: 4px;
            margin-top: 2px;
            margin-bottom: 6px;
            font-weight: 500;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease-out;
        }
        .status-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Sapper Mode Visuals */
        .sapper-mode-active #main-header {
            border-bottom: 1px solid rgba(209, 78, 66, 0.3);
            background: rgba(20, 5, 5, 0.9);
        }
        
        .sapper-progress-container {
            position: absolute;
            bottom: 80px;
            left: 0; right: 0;
            display: flex;
            flex-col;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .sapper-ring {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .sapper-ring-fill {
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            border: 3px solid #D14E42;
            border-left-color: transparent;
            border-bottom-color: transparent;
            transform: rotate(-45deg); /* Start point */
            opacity: 0;
        }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose strong { font-weight: 600; }
        .prose code { 
            background: rgba(0,0,0,0.3); 
            padding: 2px 4px; 
            border-radius: 4px; 
            font-family: 'SF Mono', monospace; 
            font-size: 0.9em; 
        }

        /* Typing Dots */
        .typing-dot {
            width: 6px; height: 6px;
            background-color: #AEAEB2;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-primary selection:text-white">

    <div class="scanlines"></div>

    <!-- BOOT SCREEN -->
    <div id="boot-screen" class="fixed inset-0 z-[100] bg-black flex flex-col justify-start p-8 pt-16 font-mono text-xs md:text-sm text-primary overflow-hidden tracking-wide">
        <div id="boot-log" class="space-y-1.5 opacity-90"></div>
        <div class="mt-2 animate-pulse">_</div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[90] pointer-events-none opacity-0 transition-all duration-300 transform -translate-y-4 w-auto max-w-[90%]">
        <div class="bg-surfaceHighlight/95 border border-white/10 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 backdrop-blur-md">
            <div class="w-1.5 h-1.5 rounded-full bg-primary shrink-0"></div>
            <span id="toast-message" class="text-xs font-medium tracking-wide truncate">Notification</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 transition-opacity duration-700">
        <!-- Centered Container -->
        <div class="w-full max-w-sm flex flex-col items-center justify-center space-y-12 transform -translate-y-8">
            <!-- Logo -->
            <div class="relative w-24 h-24 flex items-center justify-center">
                <i class="ph-fill ph-fox-logo text-7xl text-primary drop-shadow-2xl"></i>
            </div>
            
            <div class="text-center space-y-1">
                <h1 class="text-2xl font-bold tracking-tight text-white">f0xnet</h1>
                <p class="text-[11px] text-gray-500 font-medium tracking-widest uppercase">Secure Comms Relay</p>
            </div>
            
            <!-- Glass Input -->
            <div class="w-full space-y-4">
                <div class="glass-input rounded-2xl px-4 py-1 flex items-center">
                    <i class="ph ph-lock-key text-gray-500 mr-3"></i>
                    <input type="password" id="login-pass" 
                        class="w-full bg-transparent text-center text-white py-3 focus:outline-none placeholder-gray-600 font-mono text-lg tracking-[0.3em]"
                        placeholder="••••••"
                        inputmode="numeric" 
                        pattern="[0-9]*"
                        autocomplete="off"
                    >
                </div>
                <button onclick="Auth.login()" class="w-full py-4 bg-primary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 active:scale-[0.98] transition-all text-sm uppercase tracking-wider">
                    Authenticate
                </button>
            </div>
        </div>
    </div>

    <!-- APP INTERFACE ROOT CONTAINER -->
    <div id="app-interface" class="hidden h-full w-full relative">
        
        <!-- Header -->
        <header class="absolute top-0 left-0 right-0 z-30 glass pt-safe transition-all duration-500" id="main-header">
            <div class="h-[60px] w-full flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar with Stealth Settings Trigger -->
                    <div class="relative" id="avatar-btn">
                        <div class="w-9 h-9 rounded-full bg-surfaceHighlight flex items-center justify-center border border-white/5 overflow-hidden pointer-events-none">
                            <i class="ph-fill ph-user text-gray-400"></i>
                        </div>
                        <div id="status-dot" class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full bg-statusGray border-2 border-[#101010] pointer-events-none"></div>
                    </div>
                    <div class="flex flex-col justify-center">
                        <span id="contact-name" class="text-white font-semibold text-[15px] leading-tight tracking-tight">f0xnet</span>
                        <span id="connection-status" class="text-[11px] text-gray-500 font-medium leading-none mt-0.5">Offline</span>
                    </div>
                </div>
                
                <!-- Only Search Visible now -->
                <div class="flex items-center gap-1">
                    <button onclick="UI.toggleSearch()" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-white transition-colors active:bg-white/5">
                        <i class="ph ph-magnifying-glass text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Search Bar -->
        <div id="search-bar-container" class="hidden absolute left-0 right-0 z-20 bg-black/80 backdrop-blur-md border-b border-white/5 px-4 py-2 animate-fade-in search-offset-top">
            <div class="glass-input rounded-xl flex items-center px-3 py-2">
                <i class="ph ph-magnifying-glass text-gray-500 mr-2"></i>
                <input type="text" id="search-input" placeholder="Search..." class="w-full bg-transparent text-white text-sm focus:outline-none" oninput="UI.handleSearch(this.value)">
                <button onclick="UI.toggleSearch()" class="text-gray-500 ml-2"><i class="ph-bold ph-x"></i></button>
            </div>
        </div>

        <!-- Sapper Activation Visuals -->
        <div class="sapper-progress-container pb-safe" id="sapper-ui">
            <div class="sapper-ring">
                <div class="sapper-ring-fill" id="sapper-fill"></div>
                <i class="ph-fill ph-skull text-white/50 text-lg transition-colors" id="sapper-icon"></i>
            </div>
            <span class="text-[10px] font-medium tracking-wide text-white/50 uppercase" id="sapper-text">Swipe up for Sapper Mode</span>
        </div>

        <!-- Chat Container -->
        <main id="chat-container" class="absolute inset-0 z-0 overflow-hidden top-spacing bottom-spacing bg-black">
            <!-- Inner wrapper for Drag-to-Reveal mechanics -->
            <div id="drag-wrapper" class="w-full h-full overflow-y-auto scroll-smooth no-scrollbar relative touch-pan-y">
                <div class="h-2"></div>
                <div id="messages-list" class="flex flex-col px-4 pb-2 transition-transform duration-75 ease-out will-change-transform"></div>
                
                <div id="typing-indicator" class="hidden w-full px-4 flex mb-2 animate-enter-message opacity-0">
                    <div class="bg-[#2C2C2E] rounded-full px-4 py-3 flex gap-1 items-center ml-0 shadow-sm">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div id="bottom-anchor" class="h-16"></div> <!-- Extra space for gesture -->
            </div>
        </main>

        <!-- Input Bar -->
        <footer class="absolute bottom-0 left-0 right-0 z-30 bg-[#161618]/90 backdrop-blur-xl border-t border-white/5 pb-safe transition-colors duration-300" id="main-footer">
            
            <div id="attachment-preview" class="hidden px-4 pb-2 pt-2 flex gap-2 overflow-x-auto"></div>

            <div class="flex items-end gap-2 px-4 py-2.5 max-w-2xl mx-auto">
                <input type="file" id="media-upload" class="hidden" accept="image/*" onchange="UI.handleFileSelect(this)">

                <button onclick="document.getElementById('media-upload').click()" class="w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-full bg-surfaceHighlight text-gray-400 active:text-white transition-colors hover:bg-white/5">
                    <i class="ph-bold ph-plus text-lg"></i>
                </button>
                
                <div class="flex-1 min-h-[36px] bg-[#1C1C1E] rounded-[18px] border border-white/5 flex items-center px-4 py-1.5 focus-within:border-primary/50 transition-colors">
                    <textarea id="message-input" rows="1" 
                        class="w-full bg-transparent text-white placeholder-[#8E8E93] focus:outline-none resize-none max-h-24 text-[16px] leading-tight py-1.5"
                        placeholder="Message"
                        oninput="UI.autoResize(this)"
                        onkeydown="UI.handleEnter(event)"
                    ></textarea>
                </div>
                
                <button onclick="Chat.send()" id="send-btn" 
                    class="w-9 h-9 flex-shrink-0 rounded-full bg-primary text-white flex items-center justify-center shadow-md active:scale-90 transition-transform disabled:opacity-50 disabled:cursor-not-allowed group">
                    <i class="ph-bold ph-arrow-up text-lg group-active:scale-90 transition-transform"></i>
                </button>
            </div>
        </footer>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60]">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="UI.toggleSettings()"></div>
        <div class="absolute bottom-0 left-0 right-0 glass-modal rounded-t-[32px] max-h-[90vh] overflow-hidden flex flex-col shadow-2xl animate-slide-up-modal ring-1 ring-white/10">
            
            <div class="w-full flex justify-center pt-3 pb-2" onclick="UI.toggleSettings()">
                <div class="w-10 h-1 bg-gray-600/40 rounded-full"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-12">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-semibold text-white">System Config</h2>
                    <button onclick="UI.toggleSettings()" class="w-8 h-8 rounded-full bg-surfaceHighlight flex items-center justify-center text-gray-400">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>
                
                <!-- Encryption Visual -->
                <div class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                        <i class="ph-fill ph-shield-check text-primary text-xl"></i>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-white">AES-256 Encryption</div>
                        <div class="text-[11px] text-gray-500">End-to-end secure tunnel active</div>
                    </div>
                </div>

                <!-- API Key -->
                <div class="space-y-2">
                    <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Uplink Key</label>
                    <input type="password" id="api-key-input" 
                        class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none font-mono" 
                        placeholder="Paste Gemini API Key"
                        oninput="Settings.handleKeyInput(this.value)">
                </div>

                <!-- Model Selector -->
                <div class="space-y-2">
                    <div class="flex justify-between px-1">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Neural Model</label>
                        <span id="model-status" class="text-[10px] text-gray-500">Standby</span>
                    </div>
                    <div class="relative">
                        <select id="model-select" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none appearance-none">
                            <option value="" disabled selected>Waiting for Key...</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                            <i class="ph-bold ph-caret-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Persona -->
                <div class="space-y-4 pt-2">
                    <div class="space-y-2">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Contact ID</label>
                        <input type="text" id="ai-name-input" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-white text-sm focus:border-primary focus:outline-none" placeholder="f0xnet">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide ml-1">Protocol Rules</label>
                        <textarea id="system-prompt" rows="3" class="w-full bg-surfaceHighlight border border-white/5 rounded-xl p-4 text-sm text-gray-300 font-mono focus:border-primary focus:outline-none" placeholder="Instruction set..."></textarea>
                    </div>
                </div>

                <!-- Actions -->
                <button onclick="Settings.save()" class="w-full py-4 bg-white text-black font-semibold rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                    Save Changes
                </button>
                
                <div class="text-center pt-2">
                    <button onclick="Settings.wipeData()" class="text-xs text-red-500 font-medium py-2 px-4 rounded-lg hover:bg-red-500/10">Factory Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const DEFAULTS = {
            aiName: "f0xnet",
            systemPrompt: "You are a secure contact. Keep messages concise and natural. Use lowercase occasionally. Don't sound robotic.",
            model: "gemini-1.5-flash",
            apiKey: "",
            password: "",
            lastActive: Date.now(),
            sapperMode: false
        };

        const State = {
            config: { ...DEFAULTS },
            history: [],
            isFirstLoad: true,
            attachment: null,
            tapCount: 0,
            tapTimer: null,
            dragStartX: 0,
            isDragging: false,

            load() {
                const c = localStorage.getItem('f0x_config_v5');
                const h = localStorage.getItem('f0x_history_v5');
                if(c) { this.config = JSON.parse(c); this.isFirstLoad = false; }
                if(h) { this.history = JSON.parse(h); }
            },
            save() {
                localStorage.setItem('f0x_config_v5', JSON.stringify(this.config));
                localStorage.setItem('f0x_history_v5', JSON.stringify(this.history));
            },
            reset() {
                localStorage.clear();
                location.reload();
            }
        };

        const UI = {
            els: {
                app: document.getElementById('app-interface'),
                login: document.getElementById('login-screen'),
                msgList: document.getElementById('messages-list'),
                scroll: document.getElementById('drag-wrapper'), // Changed to drag wrapper
                input: document.getElementById('message-input'),
                search: document.getElementById('search-bar-container')
            },

            // --- HAPTIC ENGINE ---
            haptic(type = 'light') {
                if (!navigator.vibrate) return;
                if (type === 'light') navigator.vibrate(5);
                if (type === 'medium') navigator.vibrate(15);
                if (type === 'heavy') navigator.vibrate([20, 50, 20]);
                if (type === 'tick') navigator.vibrate(2);
            },

            showApp() {
                this.els.login.style.opacity = '0';
                setTimeout(() => {
                    this.els.login.classList.add('hidden');
                    this.els.app.classList.remove('hidden');
                    this.refresh();
                    if(!State.config.apiKey) setTimeout(() => this.toggleSettings(), 600);
                    // Init Mechanics
                    this.initSapperGesture();
                    this.initDragToReveal();
                    this.updateSapperUI();
                    this.initAvatarStealth();
                }, 700);
            },

            initAvatarStealth() {
                const av = document.getElementById('avatar-btn');
                av.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.haptic();
                    State.tapCount++;
                    if(State.tapTimer) clearTimeout(State.tapTimer);
                    
                    if(State.tapCount >= 3) {
                        this.toggleSettings();
                        State.tapCount = 0;
                    } else {
                        State.tapTimer = setTimeout(() => State.tapCount = 0, 500);
                    }
                });
            },

            // --- INSTAGRAM STYLE SAPPER GESTURE ---
            initSapperGesture() {
                const el = this.els.scroll;
                let startY = 0;
                let isPulling = false;
                const threshold = 120; // Distance to trigger
                
                const ui = document.getElementById('sapper-ui');
                const fill = document.getElementById('sapper-fill');
                const icon = document.getElementById('sapper-icon');
                const text = document.getElementById('sapper-text');

                el.addEventListener('touchstart', e => {
                    // Only if at bottom
                    if (el.scrollHeight - el.scrollTop - el.clientHeight < 5) {
                        startY = e.touches[0].clientY;
                        isPulling = true;
                    }
                }, {passive: true});

                el.addEventListener('touchmove', e => {
                    if (!isPulling) return;
                    
                    const currentY = e.touches[0].clientY;
                    const diff = startY - currentY;
                    
                    if (diff > 0) {
                        // Calculate percentage 0 to 1
                        const progress = Math.min(diff / threshold, 1);
                        
                        // Show UI
                        ui.style.opacity = progress;
                        
                        // Fill Ring
                        const rotation = -45 + (progress * 360);
                        if (progress > 0.1) {
                            fill.style.opacity = '1';
                            fill.style.transform = `rotate(${rotation}deg)`;
                        }

                        if (progress >= 1) {
                            icon.style.color = '#D14E42'; // Red icon when ready
                            icon.classList.add('animate-pulse');
                            text.textContent = "Release to Toggle";
                            if (!this.sapperReady) {
                                this.haptic('medium');
                                this.sapperReady = true;
                            }
                        } else {
                            icon.style.color = 'rgba(255,255,255,0.5)';
                            icon.classList.remove('animate-pulse');
                            text.textContent = State.config.sapperMode ? "Release to Disable" : "Swipe up for Sapper Mode";
                            this.sapperReady = false;
                        }
                    }
                }, {passive: true});

                el.addEventListener('touchend', e => {
                    isPulling = false;
                    ui.style.opacity = '0';
                    fill.style.opacity = '0';
                    
                    if (this.sapperReady) {
                        this.toggleSapperMode();
                    }
                    this.sapperReady = false;
                });
            },

            // --- iMESSAGE STYLE DRAG TO REVEAL ---
            initDragToReveal() {
                const wrapper = document.getElementById('drag-wrapper');
                const list = document.getElementById('messages-list');
                const stamps = document.querySelectorAll('.timestamp-col');
                let startX = 0;
                let currentX = 0;

                wrapper.addEventListener('touchstart', e => {
                    // If we aren't pulling up for sapper...
                    startX = e.touches[0].clientX;
                }, {passive: true});

                wrapper.addEventListener('touchmove', e => {
                    const x = e.touches[0].clientX;
                    const diff = startX - x; // Dragging left gives positive diff

                    // Only handle horizontal drag if significant
                    if (Math.abs(diff) > 10 && Math.abs(diff) > Math.abs(e.touches[0].clientY - e.touches[0].clientY)) {
                         // Dragging Left (Positive Diff)
                         if (diff > 0) {
                            const offset = Math.min(diff, 60); // Max 60px reveal
                            list.style.transform = `translateX(-${offset}px)`;
                            
                            // Fade in timestamps
                            const opacity = Math.min(diff / 50, 1);
                            document.querySelectorAll('.timestamp-col').forEach(el => el.style.opacity = opacity);
                         }
                    }
                }, {passive: true});

                wrapper.addEventListener('touchend', () => {
                    list.style.transform = `translateX(0)`;
                    document.querySelectorAll('.timestamp-col').forEach(el => el.style.opacity = '0');
                });
            },

            toggleSapperMode() {
                this.haptic('heavy');
                State.config.sapperMode = !State.config.sapperMode;
                State.save();
                this.updateSapperUI();
                
                const status = State.config.sapperMode ? "ENABLED" : "DISABLED";
                
                // System Message
                if(State.config.sapperMode) {
                    this.renderMsg('system', 'SAPPER MODE ACTIVE. MESSAGES SELF-DESTRUCT IN 60s.');
                    // Vanish animation visual
                    document.body.classList.add('animate-pulse-slow');
                    setTimeout(() => document.body.classList.remove('animate-pulse-slow'), 1000);
                } else {
                    this.renderMsg('system', 'SAPPER MODE DISABLED.');
                }
            },

            updateSapperUI() {
                const body = document.body;
                if(State.config.sapperMode) {
                    body.classList.add('sapper-mode-active');
                } else {
                    body.classList.remove('sapper-mode-active');
                }
            },

            refresh() {
                document.getElementById('contact-name').textContent = State.config.aiName;
                document.getElementById('api-key-input').value = State.config.apiKey || '';
                document.getElementById('ai-name-input').value = State.config.aiName;
                document.getElementById('system-prompt').value = State.config.systemPrompt;
                
                const select = document.getElementById('model-select');
                if(State.config.model && select.querySelector(`option[value="${State.config.model}"]`)) {
                    select.value = State.config.model;
                }

                this.renderHistory(State.history);
            },

            renderHistory(msgs) {
                this.els.msgList.innerHTML = '';
                const now = Date.now();
                const validMsgs = msgs.filter(m => !m.expiresAt || m.expiresAt > now);
                
                if(validMsgs.length !== msgs.length) {
                    State.history = validMsgs;
                    State.save();
                }

                validMsgs.forEach(msg => this.renderMsg(msg.role, msg.text, false, msg));
                this.repositionStatus();
                this.scrollToBottom();
            },

            renderMsg(role, text, animate = true, msgObj = null) {
                const time = new Date().toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
                
                // Create Row
                const row = document.createElement('div');
                row.className = 'msg-row';
                if (msgObj) row.dataset.id = msgObj.id;

                // --- Sapper Logic ---
                if(msgObj && msgObj.expiresAt) {
                    if(Date.now() > msgObj.expiresAt) return; 
                    const timeLeft = msgObj.expiresAt - Date.now();
                    setTimeout(() => {
                        row.classList.add('animate-fade-out');
                        setTimeout(() => row.remove(), 1000);
                    }, timeLeft);
                }

                if(role === 'system') {
                    const div = document.createElement('div');
                    div.className = 'msg-system animate-fade-in';
                    div.textContent = text;
                    this.els.msgList.appendChild(div);
                    return;
                } 

                // HTML Content
                const html = marked.parse(text);
                
                // Bubble
                const bubble = document.createElement('div');
                bubble.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-ai'} ${animate ? 'animate-enter-message' : ''}`;
                bubble.innerHTML = `<div class="prose prose-invert prose-sm leading-relaxed">${html}</div>`;

                // Timestamp (Hidden, revealed by drag)
                const stamp = document.createElement('div');
                stamp.className = 'timestamp-col';
                stamp.textContent = time;

                row.appendChild(bubble);
                row.appendChild(stamp);
                
                this.els.msgList.appendChild(row);

                // Handle Status Label (Only for user messages)
                if (role === 'user' && animate) {
                    this.repositionStatus();
                }

                this.scrollToBottom();
            },

            repositionStatus() {
                // Remove existing status
                const existing = document.getElementById('status-label');
                if (existing) existing.remove();

                // Find last user message
                const userRows = document.querySelectorAll('.msg-user');
                if (userRows.length === 0) return;
                
                const lastUserBubble = userRows[userRows.length - 1];
                const lastRow = lastUserBubble.closest('.msg-row');

                // Create Status Line
                const statusDiv = document.createElement('div');
                statusDiv.id = 'status-label';
                statusDiv.className = 'status-line';
                statusDiv.innerHTML = '<span>Sent</span>';
                
                // Insert AFTER the row (in the main list)
                if (lastRow.nextSibling) {
                    this.els.msgList.insertBefore(statusDiv, lastRow.nextSibling);
                } else {
                    this.els.msgList.appendChild(statusDiv);
                }

                // Animate in
                requestAnimationFrame(() => statusDiv.classList.add('status-visible'));
            },

            updateStatusText(text) {
                const el = document.getElementById('status-label');
                if(el) {
                    // Update text inside span
                    const span = el.querySelector('span');
                    if(span) span.textContent = text;
                }
            },

            scrollToBottom() {
                setTimeout(() => {
                    this.els.scroll.scrollTop = this.els.scroll.scrollHeight;
                }, 50);
            },

            showTyping(show) {
                const ind = document.getElementById('typing-indicator');
                if(show) {
                    ind.classList.remove('hidden', 'opacity-0');
                    this.updateStatusText('Seen'); 
                    this.scrollToBottom();
                } else {
                    ind.classList.add('hidden', 'opacity-0');
                }
            },

            toggleSettings() {
                this.haptic();
                document.getElementById('settings-modal').classList.toggle('hidden');
            },

            toggleSearch() {
                this.haptic();
                this.els.search.classList.toggle('hidden');
                if(!this.els.search.classList.contains('hidden')) {
                    document.getElementById('search-input').focus();
                } else {
                    this.renderHistory(State.history);
                }
            },

            handleSearch(query) {
                if(!query) {
                    this.renderHistory(State.history);
                    return;
                }
                const filtered = State.history.filter(m => m.text.toLowerCase().includes(query.toLowerCase()));
                this.els.msgList.innerHTML = '';
                filtered.forEach(msg => this.renderMsg(msg.role, msg.text, false, msg));
            },

            handleFileSelect(input) {
                const file = input.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    State.attachment = {
                        mimeType: file.type,
                        data: e.target.result.split(',')[1], 
                        url: e.target.result 
                    };
                    
                    const previewArea = document.getElementById('attachment-preview');
                    previewArea.classList.remove('hidden');
                    previewArea.innerHTML = `
                        <div class="relative inline-block animate-fade-in">
                            <img src="${e.target.result}" class="h-16 w-16 object-cover rounded-xl border border-white/20">
                            <button onclick="UI.clearAttachment()" class="absolute -top-1.5 -right-1.5 bg-gray-800 text-white border border-white/20 rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-lg"><i class="ph-bold ph-x"></i></button>
                        </div>
                    `;
                    document.getElementById('message-input').focus();
                };
                reader.readAsDataURL(file);
            },

            clearAttachment() {
                State.attachment = null;
                const previewArea = document.getElementById('attachment-preview');
                previewArea.innerHTML = '';
                previewArea.classList.add('hidden');
                document.getElementById('media-upload').value = '';
            },

            toast(msg) {
                this.haptic();
                const t = document.getElementById('toast');
                document.getElementById('toast-message').textContent = msg;
                t.classList.remove('opacity-0', '-translate-y-4');
                t.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    t.classList.remove('opacity-100', 'translate-y-0');
                    t.classList.add('opacity-0', '-translate-y-4');
                }, 3500);
            },

            autoResize(el) {
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, 100) + 'px';
            },

            handleEnter(e) {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    Chat.send();
                }
            }
        };

        const Chat = {
            getContextString() {
                const now = new Date();
                const hour = now.getHours();
                const day = now.toLocaleDateString('en-US', { weekday: 'long' });
                
                let timeDesc = "daytime";
                if(hour < 5) timeDesc = "late night (user might be tired)";
                else if(hour < 11) timeDesc = "morning";
                else if(hour > 22) timeDesc = "late night";
                
                return `[Context: It is ${day}, ${now.toLocaleTimeString()}. Timeframe: ${timeDesc}. React subtly to this if relevant, but don't overdo it.]`;
            },

            async send() {
                UI.haptic();
                const input = UI.els.input;
                const txt = input.value.trim();
                
                if(!txt && !State.attachment) return;
                
                if(!State.config.apiKey) {
                    UI.toggleSettings();
                    return UI.toast("Error: Uplink Key Missing");
                }

                input.value = '';
                input.style.height = 'auto';
                input.blur();

                let displayText = txt;
                let activeAttachment = State.attachment;

                if(activeAttachment) {
                    displayText = `![Image](${activeAttachment.url})\n\n${txt}`;
                    UI.clearAttachment();
                }

                // Sapper Logic
                let expiresAt = null;
                if(State.config.sapperMode) {
                    expiresAt = Date.now() + 60000; 
                }

                const msgData = {
                    role: 'user', 
                    text: displayText, 
                    id: Date.now(),
                    expiresAt: expiresAt
                };

                State.history.push(msgData);
                
                try { State.save(); } catch(e) {
                    State.history.pop();
                    State.history.push({...msgData, text: txt + " [IMG]"});
                    State.save();
                }
                
                UI.renderMsg('user', displayText, true, msgData);
                Status.setOnline();

                // --- Realistic Status Sequence ---
                setTimeout(() => UI.updateStatusText('Delivered'), Math.random() * 1000 + 1000);

                const readDelay = Math.random() * 4000 + 4000;
                await new Promise(r => setTimeout(r, readDelay));
                UI.updateStatusText('Seen');

                this.fetchReply(activeAttachment);
            },

            async fetchReply(attachment) {
                try {
                    // Inject Context
                    const contextStr = this.getContextString();

                    const context = State.history.slice(-15)
                        .filter(m => m.role !== 'system')
                        .map(m => {
                            let cleanText = m.text;
                            if(cleanText.startsWith('![Image]')) {
                                cleanText = cleanText.split('\n\n')[1] || "[Image Uploaded]";
                            }
                            return {
                                role: m.role === 'user' ? 'user' : 'model',
                                parts: [{ text: cleanText }]
                            };
                        });
                    
                    context.pop(); 

                    const currentParts = [];
                    const lastMsg = State.history[State.history.length - 1];
                    let textPrompt = lastMsg.text;
                    if(textPrompt.startsWith('![Image]')) textPrompt = textPrompt.split('\n\n')[1] || "";
                    
                    // Add Context to the prompt (invisible to user)
                    if(textPrompt) currentParts.push({ text: textPrompt + "\n" + contextStr });
                    
                    if(attachment) {
                        currentParts.push({
                            inlineData: {
                                mimeType: attachment.mimeType,
                                data: attachment.data
                            }
                        });
                    }
                    
                    if(currentParts.length === 0) currentParts.push({ text: "..." });

                    const payload = {
                        contents: [...context, { role: 'user', parts: currentParts }],
                        systemInstruction: { parts: [{ text: State.config.systemPrompt }] }
                    };

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${State.config.model}:generateContent?key=${State.config.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if(!res.ok) throw new Error(data.error?.message || "Protocol Error: " + res.status);
                    if(!data.candidates?.[0]?.content) {
                        if(data.promptFeedback?.blockReason) throw new Error("Connection Refused: Content Filtered");
                        throw new Error("Connection Refused: Empty Payload");
                    }

                    const reply = data.candidates[0].content.parts[0].text;

                    // Realistic Typing Logic
                    const chars = reply.length;
                    const baseTime = chars * 40; 
                    const typingTime = Math.min(Math.max(baseTime, 1500), 12000); 

                    UI.showTyping(true);

                    if(typingTime > 5000) {
                        await new Promise(r => setTimeout(r, typingTime * 0.4));
                        UI.showTyping(false); 
                        await new Promise(r => setTimeout(r, 1200)); 
                        UI.showTyping(true);
                        await new Promise(r => setTimeout(r, typingTime * 0.6));
                    } else {
                        await new Promise(r => setTimeout(r, typingTime));
                    }

                    UI.showTyping(false);

                    let expiresAt = null;
                    if(State.config.sapperMode) {
                        expiresAt = Date.now() + 60000; 
                    }

                    const aiMsg = {
                        role: 'model', 
                        text: reply,
                        expiresAt: expiresAt,
                        id: Date.now()
                    };

                    State.history.push(aiMsg);
                    State.save();
                    UI.renderMsg('model', reply, true, aiMsg);
                    
                    UI.haptic('medium'); 
                    Status.setOnline();

                } catch(e) {
                    UI.showTyping(false);
                    let errorMsg = "Secure Handshake Failed";
                    if(e.message.includes('400')) errorMsg = "Authorization Failed: Invalid Key";
                    if(e.message.includes('403')) errorMsg = "Access Denied: Region Locked";
                    if(e.message.includes('429')) errorMsg = "Network Congestion";
                    if(e.message.includes('Content Filtered')) errorMsg = "Transmission Blocked: Safety";
                    UI.toast(errorMsg);
                }
            }
        };

        const Boot = {
            log: document.getElementById('boot-log'),
            screen: document.getElementById('boot-screen'),
            
            async run() {
                if(!State.isFirstLoad) {
                    this.screen.classList.add('hidden');
                    Auth.init();
                    return;
                }

                const lines = [
                    "ESTABLISHING SECURE HANDSHAKE...",
                    "VERIFYING KEYS...",
                    "DECRYPTING STORAGE...",
                    "CONNECTION SECURE."
                ];
                
                for(let line of lines) {
                    const p = document.createElement('div');
                    p.textContent = `> ${line}`;
                    this.log.appendChild(p);
                    await new Promise(r => setTimeout(r, 400));
                }

                await new Promise(r => setTimeout(r, 400));
                this.screen.style.opacity = '0';
                setTimeout(() => {
                    this.screen.classList.add('hidden');
                    Auth.init();
                }, 500);
            }
        };

        const Auth = {
            init() {
                document.getElementById('login-screen').classList.remove('hidden');
                if(State.config.password) {
                    setTimeout(() => document.getElementById('login-pass').focus(), 100);
                }
                if(State.config.apiKey) Settings.fetchModels(State.config.apiKey);
                Status.startLoop();
            },
            login() {
                UI.haptic();
                const input = document.getElementById('login-pass');
                const val = input.value.trim();
                
                if(State.isFirstLoad) {
                    if(!val) return;
                    State.config.password = val;
                    State.save();
                    UI.showApp();
                } else {
                    if(val === State.config.password) UI.showApp();
                    else {
                        input.value = '';
                        input.classList.add('text-primary');
                        setTimeout(() => input.classList.remove('text-primary'), 500);
                    }
                }
            }
        };

        const Status = {
            startLoop() {
                this.update();
                setInterval(() => this.update(), 60000); 
            },
            update() {
                const elText = document.getElementById('connection-status');
                const elDot = document.getElementById('status-dot');
                
                const now = Date.now();
                const diff = (now - State.config.lastActive) / 1000 / 60; 

                if (diff < 5) {
                    elText.textContent = "Online";
                    elDot.style.backgroundColor = "#34C759"; 
                } else if (diff < 30) {
                    elText.textContent = "Idle";
                    elDot.style.backgroundColor = "#FFD60A"; 
                } else {
                    elText.textContent = "Offline";
                    elDot.style.backgroundColor = "#8E8E93"; 
                }
            },
            setOnline() {
                State.config.lastActive = Date.now();
                State.save();
                this.update();
            }
        };

        const Settings = {
            debounceTimer: null,

            handleKeyInput(val) {
                if(this.debounceTimer) clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    if(val.length > 20) this.fetchModels(val);
                }, 800);
            },

            async fetchModels(key) {
                const select = document.getElementById('model-select');
                const status = document.getElementById('model-status');
                
                status.textContent = "Scanning...";
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    const data = await res.json();

                    if(data.models) {
                        select.innerHTML = '';
                        const valid = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                        
                        valid.forEach(m => {
                            const name = m.name.replace('models/', '');
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.text = name;
                            select.appendChild(opt);
                        });

                        if(State.config.model && valid.some(m => m.name.includes(State.config.model))) {
                            select.value = State.config.model;
                        } else if(valid.some(m => m.name.includes('gemini-1.5-flash'))) {
                            select.value = valid.find(m => m.name.includes('gemini-1.5-flash')).name.replace('models/', '');
                        } else {
                            select.selectedIndex = 0;
                        }
                        
                        State.config.model = select.value;
                        status.textContent = "Verified";
                        status.className = "text-[10px] text-green-500";
                    }
                } catch(e) {
                    status.textContent = "Error";
                    status.className = "text-[10px] text-red-500";
                }
            },

            save() {
                UI.haptic();
                State.config.apiKey = document.getElementById('api-key-input').value.trim();
                State.config.aiName = document.getElementById('ai-name-input').value.trim() || DEFAULTS.aiName;
                State.config.systemPrompt = document.getElementById('system-prompt').value.trim();
                State.config.model = document.getElementById('model-select').value;
                
                State.save();
                UI.refresh();
                UI.toggleSettings();
                
                const updateMsg = `SECURE LOG: Protocol updated.`;
                State.history.push({role: 'system', text: updateMsg});
                UI.renderMsg('system', updateMsg);
                
                UI.toast("Settings Encrypted & Saved");
            },

            wipeData() {
                if(confirm("Confirm Wipe? Action is irreversible.")) State.reset();
            }
        };

        // Cleanup expired sapper messages periodically
        setInterval(() => {
            if(State.config.sapperMode) {
                const now = Date.now();
                State.history = State.history.filter(m => !m.expiresAt || m.expiresAt > now);
                State.save();
            }
        }, 10000);

        document.addEventListener('DOMContentLoaded', () => {
            State.load();
            marked.setOptions({ breaks: true, gfm: true });
            Boot.run();
        });
    </script>
</body>
</html>